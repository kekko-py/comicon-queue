{% extends "layout.html" %}

{% block extra_css %}
<style>
    .status-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .status-box {
        background: white;
        border-radius: 10px;
        padding: 20px;
        width: 250px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .status-box.occupied {
        background: #ffebee;
        border-left: 5px solid #ef5350;
    }

    .status-box.free {
        background: #e8f5e9;
        border-left: 5px solid #66bb6a;
    }

    .boards-container {
        display: flex;
        justify-content: center;
        gap: 30px;
    }

    .board {
        background: white;
        border-radius: 10px;
        padding: 20px;
        width: 300px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .board h2 {
        color: #1a237e;
        margin-bottom: 15px;
        text-align: center;
    }

    .board ul {
        list-style: none;
        padding: 0;
    }

    .board li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 1.1em;
    }

    .queue-list {
        list-style: none;
        padding: 0;
    }

    .queue-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #ffc107;  /* Colore per Charlie */
    }

    .card {
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-header {
        padding: 1rem;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Stili specifici per le card Charlie */
    .border-warning {
        border-color: #ffc107 !important;
    }

    .bg-warning {
        background-color: #ffc107 !important;
    }

    .text-warning {
        color: #ffc107 !important;
    }

    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
    }

    .btn-warning:hover {
        background-color: #e0a800;
        border-color: #d39e00;
        color: #000;
    }

    .next-player-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 30px auto;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
    }

    .next-player-card.highlight {
        background: #e8f5e9;
        border: 2px solid #66bb6a;
        transform: scale(1.02);
    }

    .next-player-title {
        color: #1a237e;
        font-size: 1.2em;
        margin-bottom: 10px;
    }

    .next-player-id {
        font-size: 2.5em;
        font-weight: bold;
        color: #2e7d32;
        margin: 15px 0;
    }

    .next-player-time {
        font-size: 1.3em;
        color: #666;
    }

    .hidden {
        display: none;
    }

    .skip-button {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 5px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
    }

    .skip-button:hover {
        background: #f5f5f5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .skip-icon {
        font-size: 12px;
        font-weight: bold;
    }

    .skipped-section {
        margin: 20px auto;
        max-width: 800px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .skipped-title {
        color: #1a237e;
        font-size: 1.2em;
        margin-bottom: 15px;
        text-align: center;
    }

    .skipped-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }

    .skipped-item {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .skipped-item:hover {
        background: #e0e0e0;
        transform: scale(1.05);
    }

    .skipped-item.couple {
        border-left: 4px solid #2196F3;
    }

    .skipped-item.single {
        border-left: 4px solid #4CAF50;
    }

    /* Aggiungi questi stili per i pulsanti skippati */
    .skipped-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .skipped-title {
        color: #1a237e;
        margin-bottom: 15px;
        text-align: center;
        font-size: 1.2em;
    }

    .skipped-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }

    .skipped-button {
        padding: 5px 15px;
        border-radius: 15px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9em;
    }

    .skipped-button:hover {
        background: #e9ecef;
        transform: scale(1.05);
    }

    .skipped-button.couple {
        border-left: 3px solid #007bff;
    }

    .skipped-button.single {
        border-left: 3px solid #28a745;
    }

    .skipped-button.charlie {
        border-left: 3px solid #ffc107;
    }

    /* Stili per le card dei prossimi giocatori */
    .next-players-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }

    .next-player-card {
        flex: 1;
        max-width: 400px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
    }

    .skipped-button {
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .skipped-button.couple {
        background-color: #ffd700;  /* Giallo */
        color: black;
    }

    .skipped-button.single {
        background-color: #2196F3;  /* Blu */
        color: white;
    }

    .skipped-button.charlie {
        background-color: #4CAF50;  /* Verde */
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<h1>Tabellone</h1>

<div class="status-container">
    <div class="status-box" id="alfa-status">
        <h3>Pista ALFA</h3>
        <p>Stato: <span id="alfa-state">-</span></p>
        <p>Tempo rimanente: <span id="alfa-remaining">-</span></p>
    </div>
    
    <div class="status-box" id="bravo-status">
        <h3>Pista BRAVO</h3>
        <p>Stato: <span id="bravo-state">-</span></p>
        <p>Tempo rimanente: <span id="bravo-remaining">-</span></p>
    </div>

    <div class="status-box" id="charlie-status">
        <h3>Pista CHARLIE</h3>
        <p>Stato: <span id="charlie-state">-</span></p>
        <p>Tempo rimanente: <span id="charlie-remaining">-</span></p>
    </div>
</div>

<!-- Card dei prossimi giocatori affiancate -->
<div class="next-players-container">
    <!-- Card per Coppie e Singoli -->
    <div class="next-player-card">
        <div class="next-player-title">Prossimo Giocatore ALFA/BRAVO:</div>
        <div class="next-player-id" id="next-player">-</div>
        <button class="skip-button" onclick="skipNextPlayer()">
            SKIP <span class="skip-icon">>></span>
        </button>
    </div>
    
    <!-- Card per Charlie -->
    <div class="next-player-card">
        <div class="next-player-title">Prossimo Giocatore CHARLIE:</div>
        <div class="next-player-id" id="next-charlie-player">-</div>
        <button class="skip-button" onclick="skipCharliePlayer()">
            SKIP <span class="skip-icon">>></span>
        </button>
    </div>
</div>

<div class="boards-container">
    <div class="board">
        <h2>Coda Coppie</h2>
        <ul id="couples-board"></ul>
    </div>

    <div class="board">
        <h2>Coda Singoli</h2>
        <ul id="singles-board"></ul>
    </div>

    <div class="board">
        <h2>Coda CHARLIE</h2>
        <ul id="charlie-board"></ul>
    </div>
</div>

<!-- Nuova card unica per gli skippati -->
<div class="skipped-container">
    <div class="skipped-title">Giocatori Skippati</div>
    <div class="skipped-buttons">
        <div id="skipped-couples-buttons"></div>
        <div id="skipped-singles-buttons"></div>
        <div id="skipped-charlie-buttons"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatTimeRome(date) {
        if (!date) return 'N/D';
        
        // Crea un formatter per l'ora di Roma
        const options = {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'Europe/Rome'
        };
        
        return new Date(date).toLocaleTimeString('it-IT', options);
    }

    function updateStatus() {
        $.get('/get_status', function(data) {
            // Aggiorna lo stato e il colore della card ALFA
            $('#alfa-state').text(data.alfa_status);
            $('#alfa-remaining').text(data.alfa_remaining);
            $('#alfa-status')
                .removeClass('occupied free')
                .addClass(data.alfa_status === 'Occupata' ? 'occupied' : 'free');

            // Aggiorna lo stato e il colore della card BRAVO
            $('#bravo-state').text(data.bravo_status);
            $('#bravo-remaining').text(data.bravo_remaining);
            $('#bravo-status')
                .removeClass('occupied free')
                .addClass(data.bravo_status === 'Occupata' ? 'occupied' : 'free');

            // Aggiorna lo stato e il colore della card CHARLIE
            $('#charlie-state').text(data.charlie_status);
            $('#charlie-remaining').text(data.charlie_remaining);
            $('#charlie-status')
                .removeClass('occupied free')
                .addClass(data.charlie_status === 'Occupata' ? 'occupied' : 'free');
        });
    }

    function updateBoards() {
        $.get('/simulate', function(data) {
            $('#couples-board').empty();
            $('#singles-board').empty();

            // Aggiorna i tabelloni
            data.couples.forEach(function(item) {
                let timeDisplay = item[2] === "PROSSIMO INGRESSO" ? 
                    "PROSSIMO INGRESSO" : 
                    formatTimeRome(item[2]);
                $('#couples-board').append(`<li>${item[1]} - Ingresso: ${timeDisplay}</li>`);
            });

            data.singles.forEach(function(item) {
                let timeDisplay = item[2] === "PROSSIMO INGRESSO" ? 
                    "PROSSIMO INGRESSO" : 
                    formatTimeRome(item[2]);
                $('#singles-board').append(`<li>${item[1]} - Ingresso: ${timeDisplay}</li>`);
            });

            // Gestisci la notifica del prossimo giocatore
            if (data.next_player) {
                $('#next-player-notification').removeClass('hidden').addClass('highlight');
                $('#next-player-id').text(data.next_player);
            } else {
                $('#next-player-notification').addClass('hidden').removeClass('highlight');
            }
        });
    }

    function skipNextPlayer() {
        const nextPlayer = document.getElementById('next-player').textContent;
        if (nextPlayer && nextPlayer !== '-') {
            fetch('/skip_next_player', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: nextPlayer })
            })
            .then(response => response.json())
            .then(() => {
                fetch('/simulate')
                    .then(response => response.json())
                    .then(data => {
                        // Prima controlla se ci sono coppie
                        if (data.couples && data.couples.length > 0) {
                            document.getElementById('next-player').textContent = data.couples[0][1];
                        }
                        // Se non ci sono coppie, controlla i singoli
                        else if (data.singles && data.singles.length > 0) {
                            document.getElementById('next-player').textContent = data.singles[0][1];
                        }
                        // Se non ci sono né coppie né singoli
                        else {
                            document.getElementById('next-player').textContent = '-';
                        }
                        updateDashboard();
                        updateSkipped();
                    });
            });
        }
    }

    function updateSkippedList() {
        $.get('/get_skipped', function(data) {
            const skippedList = $('#skipped-list');
            skippedList.empty();
            
            data.couples.forEach(function(couple) {
                skippedList.append(`
                    <div class="skipped-item couple" onclick="restoreSkipped('${couple.id}')">
                        ${couple.id}
                    </div>
                `);
            });
            
            data.singles.forEach(function(single) {
                skippedList.append(`
                    <div class="skipped-item single" onclick="restoreSkipped('${single.id}')">
                        ${single.id}
                    </div>
                `);
            });
        });
    }

    function restoreSkipped(playerId) {
        console.log('Tentativo di ripristino giocatore:', playerId);
        $.ajax({
            url: '/restore_skipped',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({id: playerId}),
            success: function(response) {
                console.log('Giocatore ripristinato con successo:', playerId);
                console.log('Risposta server:', response);
                updateSkippedList();
                updateBoards();
            },
            error: function(error) {
                console.error('Errore durante il ripristino del giocatore:', error);
            }
        });
    }

    function updateDashboard() {
        fetch('/simulate')
            .then(response => response.json())
            .then(data => {
                // Aggiorna la coda coppie
                const couplesBoard = document.getElementById('couples-board');
                couplesBoard.innerHTML = '';
                data.couples.forEach(player => {
                    const timeDisplay = player[2] === "PROSSIMO INGRESSO" ? 
                        "PROSSIMO INGRESSO" : 
                        formatTimeRome(player[2]);
                    const li = document.createElement('li');
                    li.textContent = `${player[1]} - Ingresso: ${timeDisplay}`;
                    couplesBoard.appendChild(li);
                });

                // Aggiorna la coda singoli
                const singlesBoard = document.getElementById('singles-board');
                singlesBoard.innerHTML = '';
                data.singles.forEach(player => {
                    const timeDisplay = player[2] === "PROSSIMO INGRESSO" ? 
                        "PROSSIMO INGRESSO" : 
                        formatTimeRome(player[2]);
                    const li = document.createElement('li');
                    li.textContent = `${player[1]} - Ingresso: ${timeDisplay}`;
                    singlesBoard.appendChild(li);
                });

                // Aggiorna la coda Charlie
                const charlieBoard = document.getElementById('charlie-board');
                charlieBoard.innerHTML = '';
                data.charlie.forEach(player => {
                    const timeDisplay = player[2] === "PROSSIMO INGRESSO" ? 
                        "PROSSIMO INGRESSO" : 
                        formatTimeRome(player[2]);
                    const li = document.createElement('li');
                    li.textContent = `${player[1]} - Ingresso: ${timeDisplay}`;
                    charlieBoard.appendChild(li);
                });

                // Aggiorna i prossimi giocatori
                document.getElementById('next-player').textContent = 
                    data.next_player || '-';
                document.getElementById('next-charlie-player').textContent = 
                    data.next_charlie_player || '-';
            });

        // Aggiorna la visualizzazione degli skippati
        updateSkipped();
    }

    function skipCharliePlayer() {
        fetch('/skip_charlie_player', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(() => updateDashboard());
    }

    // Aggiorna la dashboard ogni secondo
    setInterval(updateDashboard, 1000);
    
    // Aggiorna lo stato ogni secondo
    setInterval(updateStatus, 1000);
    updateDashboard();

    // Aggiorna lo stato all'avvio della pagina
    $(document).ready(function() {
        updateStatus();
        updateDashboard();
    });

    // Aggiorna la visualizzazione degli skippati
    function updateSkipped() {
        fetch('/get_skipped')
            .then(response => response.json())
            .then(data => {
                const skippedContainer = document.querySelector('.skipped-buttons');
                skippedContainer.innerHTML = '';

                // Gestione coppie skippate
                if (data.couples && data.couples.length > 0) {
                    data.couples.forEach(player => {
                        const button = document.createElement('button');
                        button.className = 'skipped-button couple';
                        button.setAttribute('data-id', player.id);
                        button.textContent = player.id;
                        button.onclick = () => restoreSkipped(player.id);
                        skippedContainer.appendChild(button);
                    });
                }

                // Gestione singoli skippati
                if (data.singles && data.singles.length > 0) {
                    data.singles.forEach(player => {
                        const button = document.createElement('button');
                        button.className = 'skipped-button single';
                        button.setAttribute('data-id', player.id);
                        button.textContent = player.id;
                        button.onclick = () => restoreSkipped(player.id);
                        skippedContainer.appendChild(button);
                    });
                }

                // Gestione charlie skippati
                if (data.charlie && data.charlie.length > 0) {
                    data.charlie.forEach(player => {
                        const button = document.createElement('button');
                        button.className = 'skipped-button charlie';
                        button.setAttribute('data-id', player.id);
                        button.textContent = player.id;
                        button.onclick = () => restoreSkipped(player.id);
                        skippedContainer.appendChild(button);
                    });
                }
            })
            .catch(error => {
                console.error('Errore durante il recupero degli skipped:', error);
            });
    }

    // Assicurati che la funzione venga chiamata regolarmente
    setInterval(updateSkipped, 1000);
    $(document).ready(function() {
        updateSkipped();
    });
</script>
{% endblock %}